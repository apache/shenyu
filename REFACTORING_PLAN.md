# Apache Shenyu 重构计划

## 1. 重构目标

- **性能优化**: 减少高吞吐场景下的性能开销
- **代码简化**: 降低复杂度，提高可读性和可维护性
- **架构清晰**: 统一并发策略，消除不一致的设计模式
- **向后兼容**: 确保所有现有插件和功能正常工作
- **开发体验**: 改善开发者体验，提供更清晰的API

## 2. 重构阶段规划

### 阶段1: 核心性能改进 (高优先级 - 1-2周)

#### 2.1 Plugin Chain 执行优化
**问题**: `DefaultShenyuPluginChain.execute()` 使用递归可能导致栈溢出
**解决方案**: 转换为迭代式执行
**文件**: `shenyu-web/src/main/java/org/apache/shenyu/web/handler/ShenyuWebHandler.java`
**任务**:
- [ ] 设计迭代式插件执行逻辑
- [ ] 实现新的 `DefaultShenyuPluginChain`
- [ ] 添加性能基准测试
- [ ] 验证向后兼容性

#### 2.2 Plugin Management 重构
**问题**: `putExtPlugins()` 方法包含复杂的嵌套流操作和多次遍历
**解决方案**: 单次遍历 + Map查找优化
**文件**: `shenyu-web/src/main/java/org/apache/shenyu/web/handler/ShenyuWebHandler.java`
**任务**:
- [ ] 使用 HashMap 存储现有插件用于 O(1) 查找
- [ ] 单次遍历 extPlugins 进行分类处理
- [ ] 提取独立方法处理添加/更新逻辑
- [ ] 添加单元测试覆盖边界情况

#### 2.3 并发策略标准化
**问题**: 混合使用 volatile + synchronized，部分方法缺少同步
**解决方案**: 统一使用 CopyOnWriteArrayList 或完全同步
**文件**: `shenyu-web/src/main/java/org/apache/shenyu/web/handler/ShenyuWebHandler.java`
**任务**:
- [ ] 评估 CopyOnWriteArrayList vs synchronized 方案
- [ ] 实施选定的并发策略
- [ ] 移除冗余的 volatile 关键字（如果使用 COW）
- [ ] 添加并发测试用例

### 阶段2: API 简化与优化 (中优先级 - 2-3周)

#### 2.4 ShenyuPlugin 接口简化
**问题**: 多个 skip 方法造成 API 膨胀
**解决方案**: 引入 SkipStrategy 模式或简化方法签名
**文件**: `shenyu-plugin/shenyu-plugin-api/src/main/java/org/apache/shenyu/plugin/api/ShenyuPlugin.java`
**任务**:
- [ ] 设计统一的 skip 机制
- [ ] 保持向后兼容的默认实现
- [ ] 更新所有内置插件使用新API
- [ ] 更新文档和示例

#### 2.5 日志性能优化
**问题**: 所有插件强制记录执行时间，影响性能
**解决方案**: 可配置的日志级别和条件日志记录
**文件**: `shenyu-plugin/shenyu-plugin-api/src/main/java/org/apache/shenyu/plugin/api/ShenyuPlugin.java`
**任务**:
- [ ] 添加配置属性控制日志详细程度
- [ ] 实现条件日志记录逻辑
- [ ] 提供插件级别的日志控制选项
- [ ] 更新默认配置文件

### 阶段3: 依赖和配置优化 (中优先级 - 1-2周)

#### 2.6 Bootstrap 依赖瘦身
**问题**: shenyu-bootstrap 包含所有插件依赖，导致包体积过大
**解决方案**: 使用 Maven profiles 或可选依赖
**文件**: `shenyu-bootstrap/pom.xml`
**任务**:
- [ ] 分析实际使用频率最高的插件
- [ ] 创建不同的构建 profile（minimal, standard, full）
- [ ] 更新构建文档和 README
- [ ] 验证不同 profile 的功能完整性

#### 2.7 版本管理集中化
**问题**: 版本号分散定义，容易出现不一致
**解决方案**: 在 parent POM 中集中管理版本
**文件**: `pom.xml` (parent), `shenyu-bootstrap/pom.xml`
**任务**:
- [ ] 将所有版本属性移到 parent POM
- [ ] 使用 dependencyManagement 统一版本
- [ ] 清理重复的版本定义

### 阶段4: 代码质量提升 (低优先级 - 持续进行)

#### 2.8 错误处理标准化
**问题**: 异常处理不一致，缺乏统一模式
**任务**:
- [ ] 定义统一的异常处理策略
- [] 创建自定义异常类型
- [ ] 在关键路径添加适当的错误处理

#### 2.9 公共工具提取
**问题**: 相似逻辑在多处重复
**任务**:
- [ ] 识别重复代码模式
- [ ] 提取到公共工具类
- [ ] 更新现有代码使用工具类

## 3. 技术风险与缓解措施

### 3.1 向后兼容性风险
**风险**: 插件开发者可能依赖现有行为
**缓解措施**:
- 保持所有公共API不变
- 新功能通过默认方法或配置启用
- 提供详细的迁移指南
- 在发布前进行充分的兼容性测试

### 3.2 性能回归风险
**风险**: 重构可能引入新的性能瓶颈
**缓解措施**:
- 建立性能基准测试套件
- 每个变更都要进行性能验证
- 使用 A/B 测试对比重构前后性能

### 3.3 并发安全风险
**风险**: 并发策略变更可能引入竞态条件
**缓解措施**:
- 编写全面的并发测试
- 使用静态分析工具检测潜在问题
- 在 staging 环境充分测试

## 4. 测试策略

### 4.1 单元测试
- 覆盖所有重构的边界情况
- 验证向后兼容性
- 测试并发场景

### 4.2 集成测试
- 端到端插件执行流程
- 多插件组合场景
- 配置变更场景

### 4.3 性能测试
- 建立基准性能指标
- 对比重构前后性能
- 压力测试高并发场景

### 4.4 兼容性测试
- 现有插件功能验证
- 第三方插件兼容性测试
- 配置文件兼容性验证

## 5. 里程碑计划

### 里程碑1: 核心性能改进完成 (第2周)
- [ ] Plugin Chain 迭代式执行完成
- [ ] Plugin Management 优化完成
- [ ] 并发策略标准化完成
- [ ] 基准性能测试通过

### 里程碑2: API 简化完成 (第5周)
- [ ] ShenyuPlugin 接口优化完成
- [ ] 日志性能优化完成
- [ ] 所有内置插件适配新API

### 里程碑3: 依赖优化完成 (第7周)
- [ ] Bootstrap 依赖瘦身完成
- [ ] 版本管理集中化完成
- [ ] 多profile构建验证通过

### 里程碑4: 代码质量提升 (持续)
- [ ] 错误处理标准化
- [ ] 公共工具提取
- [ ] 文档更新完成

## 6. 资源需求

### 6.1 人力资源
- **核心开发者**: 2-3人，负责主要重构工作
- **测试工程师**: 1人，负责测试用例编写和验证
- **文档工程师**: 0.5人，负责文档更新

### 6.2 时间估算
- **总时长**: 7-8周
- **核心阶段**: 2周
- **API优化**: 3周
- **依赖优化**: 2周
- **缓冲时间**: 1-2周

### 6.3 工具需求
- **性能测试工具**: JMH, Gatling
- **静态分析工具**: SonarQube, Checkstyle
- **并发测试工具**: JCStress

## 7. 成功指标

### 7.1 性能指标
- Plugin Chain 执行时间减少 10-15%
- 内存占用减少 5-10%
- GC 压力降低

### 7.2 代码质量指标
- 代码复杂度降低 (Cyclomatic Complexity)
- 重复代码减少 20%+
- 测试覆盖率提升至 85%+

### 7.3 开发体验指标
- 构建时间减少 (通过依赖瘦身)
- 新插件开发时间缩短
- 文档完整性提升

## 8. 回滚策略

如果重构过程中发现严重问题：
1. **立即停止**当前阶段的开发
2. **回滚到上一个稳定版本**
3. **分析根本原因**并制定修复方案
4. **重新评估**重构策略
5. **小步快跑**重新开始，每次只做最小可行变更

## 9. 沟通计划

- **每日站会**: 同步进展和阻塞问题
- **每周评审**: 展示本周成果，规划下周工作
- **社区公告**: 重大变更提前通知社区
- **文档更新**: 实时更新重构进展和API变更

---
*本重构计划基于对 Apache Shenyu 代码库的深入分析，旨在在保证稳定性的前提下，显著提升代码质量和性能表现。*